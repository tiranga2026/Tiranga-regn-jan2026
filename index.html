<script>
    const allEvents = {
        preprimary: [
            { name: 'Happy feet - Solo', price: 300 },
            { name: 'Innocence in paint - Solo', price: 300 },
            { name: 'Whats in my bag? - Solo', price: 300 },
            { name: 'Moudling minds - Solo', price: 300 }
        ],
        grade1: [
            { name: 'Soul Speaks - Solo', price: 300 },
            { name: 'India Icons - Solo', price: 300 },
            { name: 'Pieces to picture', price: 300 }
        ],
        grade2: [
            { name: 'Soul Speaks - Solo', price: 300 },
            { name: 'India Icons - Solo', price: 300 },
            { name: 'Pieces to picture - Solo', price: 300 }
        ],
        grade3: [
            { name: 'Two minute Tale-Mini Theatre - Solo', price: 300 },
            { name: 'A cultural MASCOT - Group(2 Persons)', price: 500 },
            { name: 'ECO Hero - Solo', price: 300 },
            { name: 'dance with a prop - Solo', price: 300 },
            { name: 'two minute medley - Solo', price: 300 }
        ],
        grade4: [
            { name: 'Two minute Tale-Mini Theatre - Solo', price: 300 },
            { name: 'A cultural MASCOT - Group(2 Persons)', price: 500 },
            { name: 'ECO Hero - Solo', price: 300 },
            { name: 'dance with a prop - Solo', price: 300 },
            { name: 'two minute medley - Solo', price: 300 }
        ],
        grade5: [
            { name: 'Two minute Tale-Mini Theatre - Solo', price: 300 },
            { name: 'A cultural MASCOT - Group(2 Persons)', price: 500 },
            { name: 'ECO Hero - Solo', price: 300 },
            { name: 'dance with a prop - Solo', price: 300 },
            { name: 'two minute medley - Solo', price: 300 },
            { name: 'States and their suprises - Group(2 Persons)', price: 500 }
        ],
        grade6: [
            { name: 'Gadget World - Solo', price: 300 },
            { name: 'Vibrant Visage - Group(2 Persons)', price: 500 },
            { name: 'Tech based triumph - Group(2 Persons)', price: 500 },
            { name: 'Dream Design Do - Solo', price: 300 },
            { name: '60 second spotlight- picture based - Solo', price: 300 },
            { name: 'Rhythm Rumble - Solo', price: 300 },
            { name: 'two minute medley - Solo', price: 300 },
            { name: 'Upscaled Art Flow - Group(2 Persons)', price: 500 },
            { name: 'States and their suprises - Group(2 Persons)', price: 500 }
        ],
        grade7: [
            { name: 'Gadget World - Solo', price: 300 },
            { name: 'Vibrant Visage - Group(2 Persons)', price: 500 },
            { name: 'Tech based triumph - Group(2 Persons)', price: 500 },
            { name: 'Dream Design Do - Solo', price: 300 },
            { name: '60 second spotlight- picture based - Solo', price: 300 },
            { name: 'Rhythm Rumble - Solo', price: 300 },
            { name: 'two minute medley - Solo', price: 300 },
            { name: 'Upscaled Art Flow - Group(2 Persons)', price: 500 }
        ],
        grade8: [
            { name: 'Gadget World - Solo', price: 300 },
            { name: 'Vibrant Visage - Group(2 Persons)', price: 500 },
            { name: 'Tech based triumph - Group(2 Persons)', price: 500 },
            { name: 'Dream Design Do - Solo', price: 300 },
            { name: '60 second spotlight- picture based - Solo', price: 300 },
            { name: 'Rhythm Rumble - Solo', price: 300 },
            { name: 'two minute medley - Solo', price: 300 },
            { name: 'Upscaled Art Flow - Group(2 Persons)', price: 500 }
        ],
        grade9: [
            { name: 'Inventia - Group(2-3 Persons)', price: 500 },
            { name: 'Pitch Bharath - Group(3-4 Persons)', price: 500 },
            { name: 'Reflection through moments - Group(2 Persons)', price: 500 },
            { name: 'Culture Carnival - Group(5 Persons)', price: 500 },
            { name: 'Digital Arena - Group(3-4 Persons)', price: 500 },
            { name: 'Path Finder - Solo', price: 300 },
            { name: 'Echoes of Eloquence - Solo', price: 300 },
            { name: 'Binary Battle - Solo', price: 300 },
            { name: 'Rhythm Rumble - Solo', price: 300 },
            { name: 'Discovery Files - Group(2-4 Persons)', price: 500 },
            { name: 'Unplugged voices - Solo', price: 300 },
            { name: 'Meme to Motion', price: 300 }
        ],
        combined: [
            { name: 'Swirl and Twirl - Group(5-10 Persons)', price: 800 },
            { name: 'Sovereignity Symphony - Group(5-12 Persons)', price: 800 },
            { name: 'From Films to Fashion - Solo', price: 300 },
            { name: 'Flash ad - Group(3-4 Persons)', price: 500 }
        ]
    };

    let selectedEvents = [];
    let eventParticipants = {};
    let currentTab = 'preprimary';

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.getAttribute('data-tab');
            switchTab(tabName);
        });
    });

    function switchTab(tabName) {
        currentTab = tabName;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(tabName).classList.add('active');
        document.getElementById('selectedGrade').value = tabName;
        
        initEvents();
        updateDisplay();
    }

    function initEvents() {
        const gridId = `eventsGrid-${currentTab}`;
        const grid = document.getElementById(gridId);
        grid.innerHTML = allEvents[currentTab].map(event => {
            const id = event.name.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (!(event.name in eventParticipants)) {
                eventParticipants[event.name] = 0;
            }
            return `
                <div class="event-item" data-event="${event.name}">
                    <div class="event-name">${event.name}</div>
                    <div class="event-price">₹${event.price}</div>
                    <div class="participant-inputs">
                        <span>Participants:</span>
                        <input 
                            type="number" 
                            id="${id}" 
                            class="participant-input"
                            min="0" 
                            max="50" 
                            value="${eventParticipants[event.name] || 0}" 
                            style="${selectedEvents.some(e => e.name === event.name) ? '' : 'display:none;'}"
                        >
                    </div>
                </div>
            `;
        }).join('');

        grid.querySelectorAll('.event-item').forEach(item => {
            const eventName = item.getAttribute('data-event');
            item.addEventListener('click', (e) => {
                if (e.target.tagName.toLowerCase() === 'input') return;
                toggleEvent(eventName);
            });
        });

        grid.querySelectorAll('.participant-input').forEach(input => {
            input.addEventListener('change', () => {
                updateDisplay();
            });
        });

        updateEventButtons();
    }

    function toggleEvent(eventName) {
        const index = selectedEvents.findIndex(e => e.name === eventName);
        const event = allEvents[currentTab].find(e => e.name === eventName);
        const inputId = eventName.toLowerCase().replace(/[^a-z0-9]/g, '');
        const input = document.getElementById(inputId);
        
        if (index > -1) {
            selectedEvents.splice(index, 1);
            if (input) {
                input.style.display = 'none';
                input.value = 0;
            }
            eventParticipants[eventName] = 0;
        } else {
            selectedEvents.push(event);
            if (input) {
                input.style.display = 'block';
                if (!input.value || input.value === '0') input.value = 1;
                eventParticipants[eventName] = parseInt(input.value) || 1;
            }
        }
        updateDisplay();
        updateEventButtons();
    }

    function updateEventButtons() {
        document.querySelectorAll('.event-item').forEach(item => {
            const eventName = item.getAttribute('data-event');
            if (selectedEvents.some(e => e.name === eventName)) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

    function updateDisplay() {
        selectedEvents.forEach(event => {
            const inputId = event.name.toLowerCase().replace(/[^a-z0-9]/g, '');
            const input = document.getElementById(inputId);
            if (input) {
                const val = parseInt(input.value);
                eventParticipants[event.name] = isNaN(val) ? 0 : val;
            }
        });

        const totalEvents = selectedEvents.length;
        const totalParticipants = Object.values(eventParticipants).reduce((sum, count) => sum + (count || 0), 0);
        const grandTotal = selectedEvents.reduce((sum, event) => {
            return sum + (event.price * (eventParticipants[event.name] || 0));
        }, 0);

        document.getElementById('totalEvents').textContent = totalEvents;
        document.getElementById('totalParticipants').textContent = totalParticipants;
        document.getElementById('totalAmount').textContent = `₹${grandTotal.toLocaleString()}`;
    }

    // TEMP: skip Imgur upload to avoid client ID and HTTP/2 issues
    async function uploadFile(file) {
        return 'Payment proof uploaded'; // Skip real upload for now
    }

    async function submitForm() {
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        const formContainer = document.querySelector('.form-container');

        const required = ['schoolName', 'contact', 'email', 'transactionId'];
        for (let field of required) {
            const el = document.getElementById(field);
            if (!el || !el.value.trim()) {
                showError(field.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()) + ' required');
                return;
            }
        }

        const fileInput = document.getElementById('paymentProof');
        if (!fileInput.files || !fileInput.files[0]) {
            showError('Payment Proof required');
            return;
        }

        if (selectedEvents.length === 0) {
            showError('Select at least one event');
            return;
        }

        const totalParticipants = Object.values(eventParticipants).reduce((sum, count) => sum + (count || 0), 0);
        if (totalParticipants === 0) {
            showError('Add participants for selected events');
            return;
        }

        submitBtn.disabled = true;
        formContainer.style.display = 'none';
        loading.style.display = 'block';

        try {
            const file = fileInput.files[0];
            const fileUrl = await uploadFile(file); // now just returns a string

            const totalAmountText = document.getElementById('totalAmount').textContent.replace(/[₹,]/g, '');
            const totalAmount = parseInt(totalAmountText) || 0;

            const formData = {
                schoolName: document.getElementById('schoolName').value.trim(),
                contact: document.getElementById('contact').value.trim(),
                email: document.getElementById('email').value.trim(),
                transactionId: document.getElementById('transactionId').value.trim(),
                eventParticipants: eventParticipants,
                selectedEvents: selectedEvents.map(e => e.name),
                totalAmount: totalAmount,
                fileUrl: fileUrl
            };

            const response = await fetch('YOUR_WEB_APP_EXEC_URL_HERE', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const result = await response.text();
            console.log('Apps Script result:', result);

            if (result.startsWith('SUCCESS')) {
                loading.style.display = 'none';
                successMsg.style.display = 'block';
            } else {
                throw new Error(result);
            }
        } catch (error) {
            showError('Submission failed: ' + (error.message || error));
            formContainer.style.display = 'block';
            loading.style.display = 'none';
            submitBtn.disabled = false;
        }
    }

    function showError(message) {
        const errorMsg = document.getElementById('errorMsg');
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        setTimeout(() => errorMsg.style.display = 'none', 5000);
    }

    initEvents();
    updateDisplay();
    document.getElementById('submitBtn').addEventListener('click', submitForm);
</script>
