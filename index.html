<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ‡®ðŸ‡³ Tiranga Registration Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container {
      max-width: 800px; margin: 0 auto;
      background: white; border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #ff6b6b, #feca57);
      padding: 30px; text-align: center; color: white;
    }
    .header h1 { font-size: 2.2em; margin-bottom: 10px; }
    .tabs { display: flex; flex-wrap: wrap; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
    .tab-btn { flex: 1; padding: 10px; border: none; background: none; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.85rem; }
    .tab-btn.active { background: #007bff; color: white; }
    .tab-content { display: none; padding: 30px 0 10px; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    input, select { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 16px; transition: all 0.3s; }
    input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    .events-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .event-item { padding: 15px; border: 2px solid #e1e5e9; border-radius: 12px; cursor: pointer; transition: all 0.3s; text-align: center; }
    .event-item:hover { border-color: #667eea; transform: translateY(-2px); }
    .event-item.selected { border-color: #ff6b6b; background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: white; transform: translateY(-3px); }
    .event-price { font-weight: bold; font-size: 1.1em; margin: 5px 0; }
    .participant-inputs { display: grid; grid-template-columns: 1fr 80px; gap: 10px; align-items: center; margin-top: 10px; }
    .participant-input { width: 100%; padding: 8px; border: 2px solid #e1e5e9; border-radius: 8px; text-align: center; font-weight: bold; }
    .participant-input:focus { border-color: #28a745; }
    .totals { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
    .total-amount { font-size: 2em; font-weight: bold; color: #28a745; margin: 10px 0; }
    .submit-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(40,167,69,0.3); }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .loading, .success { display: none; text-align: center; padding: 40px; }
    .success { background: #d4edda; border-radius: 12px; color: #155724; }
    .error { display: none; padding: 15px; background: #f8d7da; border-radius: 12px; color: #721c24; margin-bottom: 15px; font-size: 0.9rem; }
    .form-container { padding: 25px 30px 30px; }

    .qr-wrapper {
      margin: 10px auto 20px;
      width: 220px;
      height: 220px;
      border-radius: 16px;
      border: 2px dashed #ced4da;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
    }
    .qr-wrapper img {
      max-width: 90%;
      max-height: 90%;
      display: block;
    }

    @media (max-width: 768px) {
      .events-grid { grid-template-columns: 1fr; }
      .participant-inputs { grid-template-columns: 1fr; }
      .tabs { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Tiranga Registration</h1>
      <p>Complete event registration by grade level</p>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="preprimary">Pre-Primary</button>
      <button class="tab-btn" data-tab="grade1">Grade I</button>
      <button class="tab-btn" data-tab="grade2">Grade II</button>
      <button class="tab-btn" data-tab="grade3">Grade III</button>
      <button class="tab-btn" data-tab="grade4">Grade IV</button>
      <button class="tab-btn" data-tab="grade5">Grade V</button>
      <button class="tab-btn" data-tab="grade6">Grade VI</button>
      <button class="tab-btn" data-tab="grade7">Grade VII</button>
      <button class="tab-btn" data-tab="grade8">Grade VIII</button>
      <button class="tab-btn" data-tab="grade9">Grade IX-XII</button>
      <button class="tab-btn" data-tab="combined">Grades 6-12</button>
    </div>

    <div class="form-container">
      <div class="error" id="errorMsg"></div>

      <div class="form-group">
        <label>School Name *</label>
        <input type="text" id="schoolName" required>
      </div>

      <div class="form-group">
        <label>Contact Number *</label>
        <input type="tel" id="contact" required>
      </div>

      <div class="form-group">
        <label>Email *</label>
        <input type="email" id="email" required>
      </div>

      <div class="form-group">
        <label>Transaction ID *</label>
        <input type="text" id="transactionId" placeholder="e.g., TXN123456789" required>
      </div>

      <div class="form-group">
        <label>Scan to Pay (QR Code)</label>
        <div class="qr-wrapper">
          <img id="paymentQr" src="YOUR_QR_CODE_IMAGE_URL_HERE" alt="Payment QR Code">
        </div>
      </div>

      <div class="form-group">
        <label>Payment Proof *</label>
        <input type="file" id="paymentProof" accept="image/*,.pdf" required>
      </div>

      <div class="form-group">
        <label>Select Events & Participants *</label>

        <div class="tab-content active" id="preprimary">
          <div class="events-grid" id="eventsGrid-preprimary"></div>
        </div>
        <div class="tab-content" id="grade1">
          <div class="events-grid" id="eventsGrid-grade1"></div>
        </div>
        <div class="tab-content" id="grade2">
          <div class="events-grid" id="eventsGrid-grade2"></div>
        </div>
        <div class="tab-content" id="grade3">
          <div class="events-grid" id="eventsGrid-grade3"></div>
        </div>
        <div class="tab-content" id="grade4">
          <div class="events-grid" id="eventsGrid-grade4"></div>
        </div>
        <div class="tab-content" id="grade5">
          <div class="events-grid" id="eventsGrid-grade5"></div>
        </div>
        <div class="tab-content" id="grade6">
          <div class="events-grid" id="eventsGrid-grade6"></div>
        </div>
        <div class="tab-content" id="grade7">
          <div class="events-grid" id="eventsGrid-grade7"></div>
        </div>
        <div class="tab-content" id="grade8">
          <div class="events-grid" id="eventsGrid-grade8"></div>
        </div>
        <div class="tab-content" id="grade9">
          <div class="events-grid" id="eventsGrid-grade9"></div>
        </div>
        <div class="tab-content" id="combined">
          <div class="events-grid" id="eventsGrid-combined"></div>
        </div>
      </div>

      <div class="totals">
        <div>Total Events: <span id="totalEvents">0</span></div>
        <div>Total Participants: <span id="totalParticipants">0</span></div>
        <div class="total-amount" id="totalAmount">â‚¹0</div>
      </div>

      <input type="hidden" id="selectedGrade" value="preprimary">
      <button class="submit-btn" id="submitBtn">Register Now</button>
    </div>

    <div class="loading" id="loading">ðŸ“¤ Submitting...</div>
    <div class="success" id="successMsg">
      <h2>âœ… Registration Successful!</h2>
      <p>Check your Google Sheet for live updates.</p>
      <button onclick="location.reload()" style="margin-top:20px;padding:12px 30px;background:#007bff;color:white;border:none;border-radius:8px;cursor:pointer;">Register Another</button>
    </div>
  </div>

  <script>
    const allEvents = {
      preprimary: [
        { name: 'Happy feet - Solo', price: 300 },
        { name: 'Innocence in paint - Solo', price: 300 },
        { name: 'Whats in my bag? - Solo', price: 300 },
        { name: 'Moudling minds - Solo', price: 300 }
      ],
      grade1: [
        { name: 'Soul Speaks - Solo', price: 300 },
        { name: 'India Icons - Solo', price: 300 },
        { name: 'Pieces to picture', price: 300 }
      ],
      grade2: [
        { name: 'Soul Speaks - Solo', price: 300 },
        { name: 'India Icons - Solo', price: 300 },
        { name: 'Pieces to picture - Solo', price: 300 }
      ],
      grade3: [
        { name: 'Two minute Tale-Mini Theatre - Solo', price: 300 },
        { name: 'A cultural MASCOT - Group(2 Persons)', price: 500 },
        { name: 'ECO Hero - Solo', price: 300 },
        { name: 'dance with a prop - Solo', price: 300 },
        { name: 'two minute medley - Solo', price: 300 }
      ],
      grade4: [
        { name: 'Two minute Tale-Mini Theatre - Solo', price: 300 },
        { name: 'A cultural MASCOT - Group(2 Persons)', price: 500 },
        { name: 'ECO Hero - Solo', price: 300 },
        { name: 'dance with a prop - Solo', price: 300 },
        { name: 'two minute medley - Solo', price: 300 }
      ],
      grade5: [
        { name: 'Two minute Tale-Mini Theatre - Solo', price: 300 },
        { name: 'A cultural MASCOT - Group(2 Persons)', price: 500 },
        { name: 'ECO Hero - Solo', price: 300 },
        { name: 'dance with a prop - Solo', price: 300 },
        { name: 'two minute medley - Solo', price: 300 },
        { name: 'States and their suprises - Group(2 Persons)', price: 500 }
      ],
      grade6: [
        { name: 'Gadget World - Solo', price: 300 },
        { name: 'Vibrant Visage - Group(2 Persons)', price: 500 },
        { name: 'Tech based triumph - Group(2 Persons)', price: 500 },
        { name: 'Dream Design Do - Solo', price: 300 },
        { name: '60 second spotlight- picture based - Solo', price: 300 },
        { name: 'Rhythm Rumble - Solo', price: 300 },
        { name: 'two minute medley - Solo', price: 300 },
        { name: 'Upscaled Art Flow - Group(2 Persons)', price: 500 },
        { name: 'States and their suprises - Group(2 Persons)', price: 500 }
      ],
      grade7: [
        { name: 'Gadget World - Solo', price: 300 },
        { name: 'Vibrant Visage - Group(2 Persons)', price: 500 },
        { name: 'Tech based triumph - Group(2 Persons)', price: 500 },
        { name: 'Dream Design Do - Solo', price: 300 },
        { name: '60 second spotlight- picture based - Solo', price: 300 },
        { name: 'Rhythm Rumble - Solo', price: 300 },
        { name: 'two minute medley - Solo', price: 300 },
        { name: 'Upscaled Art Flow - Group(2 Persons)', price: 500 }
      ],
      grade8: [
        { name: 'Gadget World - Solo', price: 300 },
        { name: 'Vibrant Visage - Group(2 Persons)', price: 500 },
        { name: 'Tech based triumph - Group(2 Persons)', price: 500 },
        { name: 'Dream Design Do - Solo', price: 300 },
        { name: '60 second spotlight- picture based - Solo', price: 300 },
        { name: 'Rhythm Rumble - Solo', price: 300 },
        { name: 'two minute medley - Solo', price: 300 },
        { name: 'Upscaled Art Flow - Group(2 Persons)', price: 500 }
      ],
      grade9: [
        { name: 'Inventia - Group(2-3 Persons)', price: 500 },
        { name: 'Pitch Bharath - Group(3-4 Persons)', price: 500 },
        { name: 'Reflection through moments - Group(2 Persons)', price: 500 },
        { name: 'Culture Carnival - Group(5 Persons)', price: 500 },
        { name: 'Digital Arena - Group(3-4 Persons)', price: 500 },
        { name: 'Path Finder - Solo', price: 300 },
        { name: 'Echoes of Eloquence - Solo', price: 300 },
        { name: 'Binary Battle - Solo', price: 300 },
        { name: 'Rhythm Rumble - Solo', price: 300 },
        { name: 'Discovery Files - Group(2-4 Persons)', price: 500 },
        { name: 'Unplugged voices - Solo', price: 300 },
        { name: 'Meme to Motion', price: 300 }
      ],
      combined: [
        { name: 'Swirl and Twirl - Group(5-10 Persons)', price: 800 },
        { name: 'Sovereignity Symphony - Group(5-12 Persons)', price: 800 },
        { name: 'From Films to Fashion - Solo', price: 300 },
        { name: 'Flash ad - Group(3-4 Persons)', price: 500 }
      ]
    };

    let selectedEvents = [];
    let eventParticipants = {};
    let currentTab = 'preprimary';

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        switchTab(tabName);
      });
    });

    function switchTab(tabName) {
      currentTab = tabName;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(tabName).classList.add('active');
      document.getElementById('selectedGrade').value = tabName;

      initEvents();
      updateDisplay();
    }

    function initEvents() {
      const gridId = `eventsGrid-${currentTab}`;
      const grid = document.getElementById(gridId);
      grid.innerHTML = allEvents[currentTab].map(event => {
        const id = event.name.toLowerCase().replace(/[^a-z0-9]/g, '');
        if (!(event.name in eventParticipants)) {
          eventParticipants[event.name] = 0;
        }
        return `
          <div class="event-item" data-event="${event.name}">
            <div class="event-name">${event.name}</div>
            <div class="event-price">â‚¹${event.price}</div>
            <div class="participant-inputs">
              <span>Participants:</span>
              <input 
                type="number" 
                id="${id}" 
                class="participant-input"
                min="0" 
                max="50" 
                value="${eventParticipants[event.name] || 0}" 
                style="${selectedEvents.some(e => e.name === event.name) ? '' : 'display:none;'}"
              >
            </div>
          </div>
        `;
      }).join('');

      grid.querySelectorAll('.event-item').forEach(item => {
        const eventName = item.getAttribute('data-event');
        item.addEventListener('click', (e) => {
          if (e.target.tagName.toLowerCase() === 'input') return;
          toggleEvent(eventName);
        });
      });

      grid.querySelectorAll('.participant-input').forEach(input => {
        input.addEventListener('change', () => {
          updateDisplay();
        });
      });

      updateEventButtons();
    }

    function toggleEvent(eventName) {
      const index = selectedEvents.findIndex(e => e.name === eventName);
      const event = allEvents[currentTab].find(e => e.name === eventName);
      const inputId = eventName.toLowerCase().replace(/[^a-z0-9]/g, '');
      const input = document.getElementById(inputId);

      if (index > -1) {
        selectedEvents.splice(index, 1);
        if (input) {
          input.style.display = 'none';
          input.value = 0;
        }
        eventParticipants[eventName] = 0;
      } else {
        selectedEvents.push(event);
        if (input) {
          input.style.display = 'block';
          if (!input.value || input.value === '0') input.value = 1;
          eventParticipants[eventName] = parseInt(input.value) || 1;
        }
      }
      updateDisplay();
      updateEventButtons();
    }

    function updateEventButtons() {
      document.querySelectorAll('.event-item').forEach(item => {
        const eventName = item.getAttribute('data-event');
        if (selectedEvents.some(e => e.name === eventName)) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }

    function updateDisplay() {
      selectedEvents.forEach(event => {
        const inputId = event.name.toLowerCase().replace(/[^a-z0-9]/g, '');
        const input = document.getElementById(inputId);
        if (input) {
          const val = parseInt(input.value);
          eventParticipants[event.name] = isNaN(val) ? 0 : val;
        }
      });

      const totalEvents = selectedEvents.length;
      const totalParticipants = Object.values(eventParticipants).reduce((sum, count) => sum + (count || 0), 0);
      const grandTotal = selectedEvents.reduce((sum, event) => {
        return sum + (event.price * (eventParticipants[event.name] || 0));
      }, 0);

      document.getElementById('totalEvents').textContent = totalEvents;
      document.getElementById('totalParticipants').textContent = totalParticipants;
      document.getElementById('totalAmount').textContent = `â‚¹${grandTotal.toLocaleString()}`;
    }

    // TEMP: skip Imgur upload to avoid client ID / network issues
    async function uploadFile(file) {
      return 'Payment proof uploaded';
    }

    async function submitForm() {
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const successMsg = document.getElementById('successMsg');
      const formContainer = document.querySelector('.form-container');

      const required = ['schoolName', 'contact', 'email', 'transactionId'];
      for (let field of required) {
        const el = document.getElementById(field);
        if (!el || !el.value.trim()) {
          showError(field.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()) + ' required');
          return;
        }
      }

      const fileInput = document.getElementById('paymentProof');
      if (!fileInput.files || !fileInput.files[0]) {
        showError('Payment Proof required');
        return;
      }

      if (selectedEvents.length === 0) {
        showError('Select at least one event');
        return;
      }

      const totalParticipants = Object.values(eventParticipants).reduce((sum, count) => sum + (count || 0), 0);
      if (totalParticipants === 0) {
        showError('Add participants for selected events');
        return;
      }

      submitBtn.disabled = true;
      formContainer.style.display = 'none';
      loading.style.display = 'block';

      try {
        const file = fileInput.files[0];
        const fileUrl = await uploadFile(file);

        const totalAmountText = document.getElementById('totalAmount').textContent.replace(/[â‚¹,]/g, '');
        const totalAmount = parseInt(totalAmountText) || 0;

        const formData = {
          schoolName: document.getElementById('schoolName').value.trim(),
          contact: document.getElementById('contact').value.trim(),
          email: document.getElementById('email').value.trim(),
          transactionId: document.getElementById('transactionId').value.trim(),
          eventParticipants: eventParticipants,
          selectedEvents: selectedEvents.map(e => e.name),
          totalAmount: totalAmount,
          fileUrl: fileUrl
        };

        const response = await fetch('https://script.google.com/macros/s/AKfycbxCQ6Cx-6AsDaz7E9r2K0sSxRSUjIZL6TH3Gf7_Jegt1ZsaYkz65p83n62mlg7P5Y4sCw/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const result = await response.text();
        console.log('Apps Script result:', result);

        if (result.startsWith('SUCCESS')) {
          loading.style.display = 'none';
          successMsg.style.display = 'block';
        } else {
          throw new Error(result);
        }
      } catch (error) {
        showError('Submission failed: ' + (error.message || error));
        formContainer.style.display = 'block';
        loading.style.display = 'none';
        submitBtn.disabled = false;
      }
    }

    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = message;
      errorMsg.style.display = 'block';
      setTimeout(() => errorMsg.style.display = 'none', 5000);
    }

    initEvents();
    updateDisplay();
    document.getElementById('submitBtn').addEventListener('click', submitForm);
  </script>
</body>
</html>

