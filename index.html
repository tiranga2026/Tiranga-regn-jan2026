function doGet() {
  var html = ''
  + '<!DOCTYPE html>'
  + '<html>'
  + '<head>'
  + '<meta charset="UTF-8">'
  + '<title>Tiranga Registration</title>'
  + '<style>'
  // GLOBAL FUTURISTIC STYLE
  + 'body{font-family:\'Segoe UI\',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;'
  + 'background:radial-gradient(circle at 0% 0%, #ffb347 0, transparent 55%),'
  + 'radial-gradient(circle at 100% 100%, #00c9a7 0, transparent 55%),'
  + 'linear-gradient(135deg,#ff9933,#ffffff,#138808);'
  + 'background-attachment:fixed;padding:20px;}'
  + '.container{max-width:1100px;margin:auto;padding:28px 26px 30px;border-radius:24px;'
  + 'background:rgba(255,255,255,0.86);box-shadow:0 18px 45px rgba(0,0,0,0.25),'
  + '0 0 0 1px rgba(255,255,255,0.6);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);}'
  + '.logo{text-align:center;margin-bottom:15px}.logo img{max-width:180px;border-radius:20px;}'
  + 'h1{text-align:center;color:#0f6c2f;letter-spacing:0.06em;text-transform:uppercase;font-size:26px;margin-bottom:4px;}'
  + 'h2{color:#333;font-size:17px;font-weight:500;text-align:center;margin-top:4px;}'
  + 'label{font-weight:600;margin-top:12px;display:block;color:#13324a;}'
  + 'input[type=text],input[type=number],input[type=file],select{width:100%;padding:10px 14px;margin-top:6px;'
  + 'border-radius:999px;border:1px solid rgba(0,0,0,0.12);box-sizing:border-box;background:#fdfdfd;'
  + 'transition:border-color .15s,box-shadow .15s,background .15s,transform .08s;}'
  + 'input:focus,select:focus{outline:none;border-color:#138808aa;box-shadow:0 0 0 3px rgba(19,136,8,0.18);'
  + 'background:#ffffff;transform:translateY(-1px);}'
  // GRADE TOGGLE
  + '.grade{margin-top:16px;border-radius:18px;background:rgba(248,249,250,0.95);overflow:hidden;'
  + 'border:1px solid rgba(15,108,47,0.06);}'
  + '.grade-header{padding:12px 16px;background:linear-gradient(120deg,#e3f3ff,#f4fff5);'
  + 'display:flex;align-items:center;justify-content:space-between;cursor:pointer;border-radius:18px;'
  + 'transition:background-color .2s,box-shadow .2s,transform .1s;}'
  + '.grade-title{font-size:16px;font-weight:600;color:#103b6b;}'
  + '.toggle-icon{font-size:18px;color:#138808;}'
  + '.grade-header:hover{background:linear-gradient(120deg,#d2ebff,#e9ffe9);'
  + 'box-shadow:0 4px 12px rgba(0,0,0,0.12);transform:translateY(-1px);}'
  + '.grade-body{padding:10px 16px 16px;display:none;}'
  // EVENT CARDS
  + '.events-grid{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px;}'
  + '.event{flex:1 1 250px;background:linear-gradient(135deg,#ffffff,#f5fbff);border-radius:16px;'
  + 'padding:10px 14px;display:flex;align-items:center;gap:10px;'
  + 'box-shadow:0 4px 12px rgba(0,0,0,0.08);transition:transform .15s ease,box-shadow .15s ease,border-color .15s ease;'
  + 'border:1px solid #e0e0e0;}'
  + '.event:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.16);border-color:#13880833;}'
  + '.event input[type=checkbox]{transform:scale(1.2);accent-color:#138808;}'
  + '.event-title{flex:1;font-size:14px;color:#123049;}'
  + '.event-price{font-weight:600;color:#138808;white-space:nowrap;}'
  + '.event input[type=number]{width:70px;margin-top:0;}'
  // TOTAL + PAYMENT
  + '.total-box{margin-top:20px;background:rgba(233,255,233,0.95);padding:15px;border-radius:16px;text-align:center;'
  + 'box-shadow:0 6px 16px rgba(0,0,0,0.12);}'
  + '.payment-section{margin-top:20px;padding:15px;border-radius:18px;background:rgba(248,249,255,0.95);'
  + 'display:grid;grid-template-columns:1.2fr 1fr;gap:15px;box-shadow:0 8px 22px rgba(0,0,0,0.12);}'
  + '.payment-details label{margin-top:8px;}'
  + '.qr{text-align:center}'
  + '.qr img{width:220px;border:2px dashed #999;padding:10px;border-radius:20px;background:#ffffffcc;}'
  // BUTTONS
  + 'button{margin-top:20px;width:100%;padding:14px 18px;font-size:18px;'
  + 'background:linear-gradient(135deg,#19a34a,#0f7b33);color:#fff;border:none;border-radius:999px;cursor:pointer;'
  + 'box-shadow:0 8px 18px rgba(0,0,0,0.18);transition:transform .1s,box-shadow .1s,filter .15s;}'
  + 'button:hover{filter:brightness(1.05);box-shadow:0 10px 24px rgba(0,0,0,0.22);transform:translateY(-1px);}'
  + 'button:active{transform:translateY(1px);box-shadow:0 4px 12px rgba(0,0,0,0.18);}'
  // TEXT & SUMMARY
  + '#msg{text-align:center;font-weight:bold;margin-top:15px;color:#138808;font-size:18px}'
  + '#eventSummary{margin-top:15px;}'
  + '@media (max-width:768px){.payment-section{grid-template-columns:1fr;}}'
  + '</style>'
  + '</head>'
  + '<body>'
  + '<div class="container">'
  + '<div class="logo"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQkugNWL7_vu5xBj5I9fI42wPpobpJv3nhLFg&s"></div>'
  + '<h1>Tiranga Event Registration</h1>'
  + '<h2>EuroSchool HSR Tiranga Fest 2026 ðŸ‡®ðŸ‡³ â€“ Register online for a celebration of talent and creativity!</h2>'
  + '<label>School Name <span style="color:red">*</span></label>'
  + '<input id="school" required>'
  + '<label>Contact Number <span style="color:red">*</span></label>'
  + '<input id="contact" required>'
  + '<div id="grades"></div>'
  + '<div class="total-box"><h2>Total Amount: â‚¹<span id="total">0</span></h2></div>'
  + '<label>Event Summary (selected events)</label>'
  + '<select id="eventSummary"><option value="">No events selected yet</option></select>'
  + '<div class="payment-section">'
  + '  <div class="payment-details">'
  + '    <label>Transaction ID</label><input id="txn">'
  + '    <label>Upload Payment Proof</label><input type="file" id="proof" accept="image/*,.pdf">'
  + '  </div>'
  + '  <div class="qr">'
  + '    <h3>Scan to Pay</h3>'
  + '    <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=upi://pay?pa=yourupi@upi&pn=TirangaFest">'
  + '    <p><b>UPI ID:</b> yourupi@upi</p>'
  + '  </div>'
  + '</div>'
  + '<button onclick="submitForm()">Submit Registration</button>'
  + '<div id="msg"></div>'
  + '</div>'
  + '<script>'
  // EVENTS
  + 'const EVENTS={'
  + '"Pre-Primary":[["Happy Feet - Solo",300],["Innocence in Paint - Solo",300],["Whats in my Bag? - Solo",300],["Moulding Minds - Solo",300]],'
  + '"Grade I":[["Soul Speaks - Solo",300],["India Icons - Solo",300],["Pieces to Picture - Solo",300]],'
  + '"Grade II":[["Soul Speaks - Solo",300],["India Icons - Solo",300],["Pieces to Picture - Solo",300]],'
  + '"Grade III":[["Two Minute Tale - Solo",300],["A Cultural MASCOT - Group(2)",500],["ECO Hero - Solo",300],["Dance with a Prop - Solo",300],["Two Minute Medley - Solo",300]],'
  + '"Grade IV":[["Two Minute Tale - Solo",300],["A Cultural MASCOT - Group(2)",500],["ECO Hero - Solo",300],["Dance with a Prop - Solo",300],["Two Minute Medley - Solo",300]],'
  + '"Grade V":[["Two Minute Tale - Solo",300],["A Cultural MASCOT - Group(2)",500],["ECO Hero - Solo",300],["Dance with a Prop - Solo",300],["Two Minute Medley - Solo",300],["States & Surprises - Group(2)",500]],'
  + '"Grade VI":[["Gadget World - Solo",300],["Vibrant Visage - Group(2)",500],["Tech Based Triumph - Group(2)",500],["Dream Design Do - Solo",300],["60 Second Spotlight - Solo",300],["Rhythm Rumble - Solo",300],["Two Minute Medley - Solo",300],["Upscaled Art Flow - Group(2)",500],["States & Surprises - Group(2)",500]],'
  + '"Grade VII":[["Gadget World - Solo",300],["Vibrant Visage - Group(2)",500],["Tech Based Triumph - Group(2)",500],["Dream Design Do - Solo",300],["60 Second Spotlight - Solo",300],["Rhythm Rumble - Solo",300],["Two Minute Medley - Solo",300],["Upscaled Art Flow - Group(2)",500]],'
  + '"Grade VIII":[["Gadget World - Solo",300],["Vibrant Visage - Group(2)",500],["Tech Based Triumph - Group(2)",500],["Dream Design Do - Solo",300],["60 Second Spotlight - Solo",300],["Rhythm Rumble - Solo",300],["Two Minute Medley - Solo",300],["Upscaled Art Flow - Group(2)",500]],'
  + '"Grade IX-XII":[["Inventia - Group",500],["Pitch Bharath - Group",500],["Reflection Through Moments",500],["Culture Carnival",500],["Digital Arena",900],["Path Finder - Solo",300],["Echoes of Eloquence - Solo",300],["Binary Battle - Solo",300],["Rhythm Rumble - Solo",300],["Discovery Files - Group",500],["Unplugged Voices - Solo",300]]'
  + '};'
  // RENDER GRADES
  + 'const wrap=document.getElementById("grades");'
  + 'Object.keys(EVENTS).forEach(function(g){'
  + '  var gradeDiv=document.createElement("div");'
  + '  gradeDiv.className="grade";'
  + '  gradeDiv.innerHTML='
  + '"<div class=\\"grade-header\\" onclick=\\"toggleGradeBody(this)\\">" +'
  + '"<span class=\\"grade-title\\">"+g+"</span>" +'
  + '"<span class=\\"toggle-icon\\">+</span>" +'
  + '"</div><div class=\\"grade-body\\"><div class=\\"events-grid\\"></div></div>";'
  + '  var grid = gradeDiv.querySelector(".events-grid");'
  + '  EVENTS[g].forEach(function(e){'
  + '    grid.innerHTML+='
  + '"<div class=\\"event\\">" +'
  + '"<input type=\\"checkbox\\" data-grade=\\""+g+"\\" data-event-name=\\""+e[0]+"\\" data-price=\\""+e[1]+"\\" onchange=\\"calcTotal();updateSummary();\\">" +'
  + '"<div class=\\"event-title\\">"+e[0]+"</div>" +'
  + '"<div class=\\"event-price\\">â‚¹"+e[1]+"</div>" +'
  + '"<input type=\\"number\\" min=\\"1\\" placeholder=\\"#\\" onchange=\\"calcTotal();updateSummary();\\">" +'
  + '"</div>";'
  + '  });'
  + '  wrap.appendChild(gradeDiv);'
  + '});'
  // COMBINED
  + 'var dCombined=document.createElement("div");'
  + 'dCombined.className="grade";'
  + 'dCombined.innerHTML='
  + '"<div class=\\"grade-header\\" onclick=\\"toggleGradeBody(this)\\">" +'
  + '"<span class=\\"grade-title\\">Combined Events (Grade VI-XII)</span>" +'
  + '"<span class=\\"toggle-icon\\">+</span>" +'
  + '"</div><div class=\\"grade-body\\"><div class=\\"events-grid\\"></div></div>";'
  + 'var gridCombined = dCombined.querySelector(".events-grid");'
  + 'var combinedEvents=['
  + '["Swirl and Twirl - Group(5-10 Persons)",800],'
  + '["Sovereignty Symphony - Group(5-12 Persons)",800],'
  + '["From Films to Fashion - Solo",300],'
  + '["Flash Ad - Group(3-4 Persons)",500]'
  + '];'
  + 'combinedEvents.forEach(function(e){'
  + '  gridCombined.innerHTML+='
  + '"<div class=\\"event\\">" +'
  + '"<input type=\\"checkbox\\" data-grade=\\"Combined\\" data-event-name=\\""+e[0]+"\\" data-price=\\""+e[1]+"\\" onchange=\\"calcTotal();updateSummary();\\">" +'
  + '"<div class=\\"event-title\\">"+e[0]+"</div>" +'
  + '"<div class=\\"event-price\\">â‚¹"+e[1]+"</div>" +'
  + '"<input type=\\"number\\" min=\\"1\\" placeholder=\\"#\\" onchange=\\"calcTotal();updateSummary();\\">" +'
  + '"</div>";'
  + '});'
  + 'wrap.appendChild(dCombined);'
  // FUNCTIONS
  + 'function toggleGradeBody(headerEl){'
  + '  var body = headerEl.nextElementSibling;'
  + '  var icon = headerEl.querySelector(".toggle-icon");'
  + '  var isOpen = body.style.display === "block";'
  + '  body.style.display = isOpen ? "none" : "block";'
  + '  icon.textContent = isOpen ? "+" : "âˆ’";'
  + '}'
  + 'function calcTotal(){'
  + '  var total=0;'
  + '  document.querySelectorAll(".event").forEach(function(ev){'
  + '    var chk=ev.querySelector("input[type=checkbox]");'
  + '    var num=ev.querySelector("input[type=number]");'
  + '    if(chk.checked && num.value){total+=chk.dataset.price*num.value;}'
  + '  });'
  + '  document.getElementById("total").innerText=total;'
  + '}'
  + 'function updateSummary(){'
  + '  var summarySelect = document.getElementById("eventSummary");'
  + '  summarySelect.innerHTML = "";'
  + '  var opts = [];'
  + '  document.querySelectorAll(".event").forEach(function(ev){'
  + '    var chk=ev.querySelector("input[type=checkbox]");'
  + '    var num=ev.querySelector("input[type=number]");'
  + '    if(chk.checked && num.value){'
  + '      var label = chk.dataset.grade + " - " + chk.dataset.eventName + " : " + num.value;'
  + '      opts.push(label);'
  + '    }'
  + '  });'
  + '  if(opts.length===0){'
  + '    var opt=document.createElement("option");opt.value="";opt.textContent="No events selected yet";summarySelect.appendChild(opt);'
  + '  }else{'
  + '    var first=document.createElement("option");first.value="";first.textContent="Selected events ("+opts.length+")";summarySelect.appendChild(first);'
  + '    opts.forEach(function(t){var o=document.createElement("option");o.value=t;o.textContent=t;summarySelect.appendChild(o);});'
  + '  }'
  + '}'
  + 'function submitForm(){'
  + '  var school = document.getElementById("school").value.trim();'
  + '  var contact = document.getElementById("contact").value.trim();'
  + '  if(!school){alert("Please enter School Name");document.getElementById("school").focus();return;}'
  + '  if(!contact){alert("Please enter Contact Number");document.getElementById("contact").focus();return;}'
  + '  var file=document.getElementById("proof").files[0];'
  + '  if(!file){alert("Upload payment proof");return;}'
  + '  var selectedEvents = [];'
  + '  document.querySelectorAll(".event").forEach(function(ev){'
  + '    var chk=ev.querySelector("input[type=checkbox]");'
  + '    var num=ev.querySelector("input[type=number]");'
  + '    if(chk.checked && num.value){'
  + '      selectedEvents.push({grade:chk.dataset.grade,name:chk.dataset.eventName,price:Number(chk.dataset.price),count:Number(num.value)});'
  + '    }'
  + '  });'
  + '  if(selectedEvents.length===0){alert("Please select at least one event and enter number of participants/groups.");return;}'
  + '  var reader=new FileReader();'
  + '  reader.onloadend=function(){'
  + '    google.script.run.withSuccessHandler(function(){'
  + '      document.querySelectorAll(".grade").forEach(function(g){g.style.display="none";});'
  + '      document.getElementById("school").style.display="none";'
  + '      document.getElementById("contact").style.display="none";'
  + '      document.getElementById("txn").style.display="none";'
  + '      document.getElementById("proof").style.display="none";'
  + '      document.querySelector(".total-box").style.display="none";'
  + '      document.querySelector(".qr").style.display="none";'
  + '      document.querySelector("button").style.display="none";'
  + '      document.getElementById("eventSummary").style.display="none";'
  + '      document.querySelectorAll("label").forEach(function(l){l.style.display="none";});'
  + '      document.getElementById("msg").innerHTML ='
  + '        "âœ… Registration Successful!<br>" +'
  + '        "<button onclick=\\"window.location.reload()\\">Submit Another Response</button>";'
  + '    }).saveData({'
  + '      school:school,'
  + '      contact:contact,'
  + '      txn:document.getElementById("txn").value,'
  + '      total:document.getElementById("total").innerText,'
  + '      events:selectedEvents,'
  + '      file:{name:file.name,type:file.type,data:reader.result}'
  + '    });'
  + '  };'
  + '  reader.readAsDataURL(file);'
  + '}'
  + '</script>'
  + '</body>'
  + '</html>';

  return HtmlService.createHtmlOutput(html);
}

function saveData(obj){
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName("Registrations");
  if(!sh){
    sh = ss.insertSheet("Registrations");
    sh.appendRow([
      "Time",
      "School Name",
      "Contact Number",
      "Grade",
      "Event",
      "Number of Participants or Groups",
      "Price / Event",
      "Total Price / Event",
      "Transaction ID",
      "Payment Proof"
    ]);
  }

  let folder = DriveApp.getFoldersByName("Tiranga_Payment_Proofs").hasNext()
    ? DriveApp.getFoldersByName("Tiranga_Payment_Proofs").next()
    : DriveApp.createFolder("Tiranga_Payment_Proofs");

  let data = obj.file.data.split(",")[1];
  let blob = Utilities.newBlob(Utilities.base64Decode(data), obj.file.type, obj.file.name);
  let file = folder.createFile(blob);
  let proofUrl = file.getUrl();
  let time = new Date();

  // one row per event with separate columns in your order
  obj.events.forEach(function(ev){
    let totalLine = ev.price * ev.count;
    sh.appendRow([
      time,
      obj.school,
      obj.contact,
      ev.grade,
      ev.name,
      ev.count,
      ev.price,
      totalLine,
      obj.txn,
      proofUrl
    ]);
  });
}
